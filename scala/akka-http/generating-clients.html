<html><head><title>guardrail: guardrail: Java: Generating Clients</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Twilio" /><meta name="description" content="Principled code generation from OpenAPI specifications" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="guardrail: guardrail: Java: Generating Clients" /><meta name="title" property="og:title" content="guardrail: guardrail: Java: Generating Clients" /><meta name="og:site_name" content="guardrail" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Principled code generation from OpenAPI specifications" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="guardrail: guardrail: Java: Generating Clients" /><meta name="twitter:image" content="https://guardrail.dev//img/poster.png" /><meta name="twitter:description" content="Principled code generation from OpenAPI specifications" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@guardrail_code" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/default.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>guardrail</span></div></a></li> <li><a href="/" class="">Getting Started</a></li> <li><a href="/" class="">Java</a> <ul class="sub_section"> <li><a href="/java/dropwizard/" class="">Dropwizard</a></li></ul></li> <li><a href="/" class="">Scala</a> <ul class="sub_section"> <li><a href="/scala/akka-http" class="">akka-http</a></li> <li><a href="/scala/akka-http" class="">http4s</a></li></ul></li> <li><a href="/" class="">ScalaJS</a> <ul class="sub_section"> <li><a href="/scalajs/endpoints" class="">endpoints (client only)</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/twilio/guardrail"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/twilio/guardrail"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('guardrail Principled code generation from OpenAPI specifications');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('guardrail Principled code generation from OpenAPI specifications');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="twilio" data-github-repo="guardrail"><div class="content-wrapper"><section><h1 id="generating-clients">Generating clients</h1>

<p>As we’ve seen in <a href="">Generating a Server</a>, guardrail-generated servers establish a mapping between our business logic and a cordoned off a subset of HTTP. This permits us to focus on our business logic, without getting overloaded with the complexities of managing such a large protocol. The same is true with guardrail generated HTTP Clients: from a consumer’s standpoint, HTTP calls should look like regular function calls, accepting domain-specific arguments and producing domain-specific results.</p>

<p>By generating minimal clients that only have enough business knowledge to map domain types to and from HTTP, opportunities for logical errors are effecitvely removed. While this does not eliminate logical errors entirely, establishing a firm boundary between the underlying protocol and hand-written code drastically reduces the scope of possible bugs.</p>

<p>The following is an example from the <a href="https://github.com/akka/akka-http">akka-http</a> client generator:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Two constructors are provided, one accepting the `httpClient`,
// `ExecutionContext`, and `Materializer` implicitly, the other accepting
// an explicit `httpClient`, but still accepting the `ExecutionContext` and
// `Materializer` as implicits.
</span><span class="k">object</span> <span class="nc">UserClient</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">host</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"http://petstore.swagger.io"</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">httpClient</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">,</span> <span class="n">mat</span><span class="k">:</span> <span class="kt">Materializer</span><span class="o">)</span><span class="k">:</span> <span class="kt">UserClient</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">UserClient</span><span class="o">(</span><span class="n">host</span> <span class="k">=</span> <span class="n">host</span><span class="o">)(</span><span class="n">httpClient</span> <span class="k">=</span> <span class="n">httpClient</span><span class="o">,</span> <span class="n">ec</span> <span class="k">=</span> <span class="n">ec</span><span class="o">,</span> <span class="n">mat</span> <span class="k">=</span> <span class="n">mat</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">httpClient</span><span class="o">(</span><span class="n">httpClient</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">],</span> <span class="n">host</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"http://petstore.swagger.io"</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">,</span> <span class="n">mat</span><span class="k">:</span> <span class="kt">Materializer</span><span class="o">)</span><span class="k">:</span> <span class="kt">UserClient</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">UserClient</span><span class="o">(</span><span class="n">host</span> <span class="k">=</span> <span class="n">host</span><span class="o">)(</span><span class="n">httpClient</span> <span class="k">=</span> <span class="n">httpClient</span><span class="o">,</span> <span class="n">ec</span> <span class="k">=</span> <span class="n">ec</span><span class="o">,</span> <span class="n">mat</span> <span class="k">=</span> <span class="n">mat</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">class</span> <span class="nc">UserClient</span><span class="o">(</span><span class="n">host</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"http://petstore.swagger.io"</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">httpClient</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">,</span> <span class="n">mat</span><span class="k">:</span> <span class="kt">Materializer</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">basePath</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"/v2"</span>
  <span class="k">def</span> <span class="n">createUser</span><span class="o">(</span><span class="n">body</span><span class="k">:</span> <span class="kt">User</span><span class="o">,</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">IgnoredEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">allHeaders</span> <span class="k">=</span> <span class="n">headers</span> <span class="o">++</span> <span class="n">scala</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">immutable</span><span class="o">.</span><span class="nc">Seq</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]]().</span><span class="n">flatten</span>
    <span class="n">makeRequest</span><span class="o">(</span><span class="nc">HttpMethods</span><span class="o">.</span><span class="nc">POST</span><span class="o">,</span> <span class="n">host</span> <span class="o">+</span> <span class="n">basePath</span> <span class="o">+</span> <span class="s">"/user"</span><span class="o">,</span> <span class="n">allHeaders</span><span class="o">,</span> <span class="n">body</span><span class="o">,</span> <span class="nc">HttpProtocols</span><span class="o">.</span><span class="n">`HTTP/1.1`</span><span class="o">).</span><span class="n">flatMap</span><span class="o">(</span><span class="n">req</span> <span class="k">=&gt;</span> <span class="n">wrap</span><span class="o">[</span><span class="kt">IgnoredEntity</span><span class="o">](</span><span class="n">httpClient</span><span class="o">,</span> <span class="n">req</span><span class="o">))</span>
  <span class="o">}</span>
  <span class="k">def</span> <span class="n">createUsersWithArrayInput</span><span class="o">(</span><span class="n">body</span><span class="k">:</span> <span class="kt">IndexedSeq</span><span class="o">[</span><span class="kt">User</span><span class="o">],</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">IgnoredEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">def</span> <span class="n">createUsersWithListInput</span><span class="o">(</span><span class="n">body</span><span class="k">:</span> <span class="kt">IndexedSeq</span><span class="o">[</span><span class="kt">User</span><span class="o">],</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">IgnoredEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">def</span> <span class="n">loginUser</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">def</span> <span class="n">logoutUser</span><span class="o">(</span><span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">IgnoredEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">def</span> <span class="n">getUserByName</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">def</span> <span class="n">updateUser</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">body</span><span class="k">:</span> <span class="kt">User</span><span class="o">,</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">IgnoredEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
  <span class="k">def</span> <span class="n">deleteUser</span><span class="o">(</span><span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">headers</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">)</span><span class="k">:</span> <span class="kt">EitherT</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">HttpResponse</span><span class="o">]</span>, <span class="kt">IgnoredEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="separation-of-protocol-concerns-from-api-level-concerns">Separation of protocol-concerns from API-level concerns</h2>

<p>As guardrail clients are built ontop of the function type <code class="highlighter-rouge">HttpRequest =&gt; Future[HttpResponse]</code>, client configuration is reduced to function composition. Some ideas:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">singleRequestHttpClient</span> <span class="k">=</span> <span class="o">{</span> <span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="nc">Http</span><span class="o">().</span><span class="n">singleRequest</span><span class="o">(</span><span class="n">req</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">retryingHttpClient</span> <span class="k">=</span> <span class="o">{</span> <span class="n">nextClient</span><span class="k">:</span> <span class="o">(</span><span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="n">nextClient</span><span class="o">(</span><span class="n">req</span><span class="o">).</span><span class="n">flatMap</span><span class="o">(</span><span class="n">resp</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">intValue</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="o">)</span> <span class="n">nextClient</span><span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="k">else</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">resp</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">metricsHttpClient</span> <span class="k">=</span> <span class="o">{</span> <span class="n">nextClient</span><span class="k">:</span> <span class="o">(</span><span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">])</span> <span class="k">=&gt;</span>
    <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">resp</span> <span class="k">=</span> <span class="n">nextClient</span><span class="o">(</span><span class="n">req</span><span class="o">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">onSuccess</span> <span class="o">{</span> <span class="nc">_resp</span> <span class="k">=&gt;</span>
            <span class="n">trackMetrics</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="o">,</span> <span class="nc">_resp</span><span class="o">.</span><span class="n">status</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="n">resp</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Track metrics for every request, even retries
</span><span class="k">val</span> <span class="n">retryingMetricsClient1</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">]</span> <span class="k">=</span> <span class="n">retryingHttpClient</span><span class="o">(</span><span class="n">metricsHttpClient</span><span class="o">(</span><span class="n">singleRequestHttpClient</span><span class="o">))</span>

<span class="c1">// Only track metrics for requests we didn't have to retry
</span><span class="k">val</span> <span class="n">retryingMetricsClient2</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">HttpResponse</span><span class="o">]</span> <span class="k">=</span> <span class="n">metricsHttpClient</span><span class="o">(</span><span class="n">retryingHttpClient</span><span class="o">(</span><span class="n">singleRequestHttpClient</span><span class="o">))</span>
</code></pre></div></div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swagger.min.js"></script><script>hljs.configure({languages:['scala','java','bash','yaml','swagger']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'twilio/guardrail'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>